<main>
  <div class="max-w-7xl mx-auto px-6 py-8">
    <h1 class="text-3xl font-bold mb-2">Users</h1>
  </div>

  <div class="max-w-7xl mx-auto px-6 mb-4 flex items-end">
    <form
      [formGroup]="userForm"
      (ngSubmit)="onSubmit()"
      class="flex flex-col gap-4 w-full max-w-2xl"
      aria-label="User form"
    >
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="user-name" class="block text-sm font-medium mb-2">Name</label>
          <input
            id="user-name"
            formControlName="name"
            placeholder="Full name"
            class="w-full rounded bg-slate-800 text-slate-100 px-4 py-2 transition text-sm font-medium focus:outline-none focus:ring-2 focus:ring-emerald-600"
          />
          @if (userForm.get('name')?.touched && nameError) {
            <p class="text-red-400 text-xs mt-1">{{ nameError }}</p>
          }
        </div>

        <div>
          <label for="user-email" class="block text-sm font-medium mb-2">Email</label>
          <input
            id="user-email"
            formControlName="email"
            type="email"
            placeholder="user@example.com"
            class="w-full rounded bg-slate-800 text-slate-100 px-4 py-2 transition text-sm font-medium focus:outline-none focus:ring-2 focus:ring-emerald-600"
          />
          @if (userForm.get('email')?.touched && emailError) {
            <p class="text-red-400 text-xs mt-1">{{ emailError }}</p>
          }
        </div>

        <div>
          <label for="user-location" class="block text-sm font-medium mb-2">Location</label>
          <input
            id="user-location"
            formControlName="location"
            placeholder="City, Country"
            class="w-full rounded bg-slate-800 text-slate-100 px-4 py-2 transition text-sm font-medium focus:outline-none focus:ring-2 focus:ring-emerald-600"
          />
          @if (userForm.get('location')?.touched && locationError) {
            <p class="text-red-400 text-xs mt-1">{{ locationError }}</p>
          }
        </div>
      </div>

      <div class="flex gap-2">
        <button
          type="submit"
          [disabled]="userForm.invalid"
          class="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-600/50 disabled:cursor-not-allowed transition text-sm font-medium focus:outline-none focus:ring-2 focus:ring-emerald-600"
        >
          {{ isEditMode ? 'Edit user' : 'Add User' }}
        </button>
        @if (isEditMode) {
          <button
            type="button"
            (click)="cancelEdit()"
            class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 transition text-sm font-medium focus:outline-none focus:ring-2 focus:ring-emerald-600"
          >
            Cancel
          </button>
        }
      </div>
    </form>
  </div>

  <div class="max-w-7xl mx-auto px-6 pb-12">
    @if (userService.loadingSignal()) {
      <div class="text-center py-12 text-slate-400" aria-live="polite" aria-busy="true">
        <div class="animate-pulse">Loading users...</div>
      </div>
    }

    @if (!userService.loadingSignal() && userService.usersSignal().length === 0) {
      <p class="text-center py-12 text-slate-400 text-lg" aria-live="polite">No users found</p>
    }

    @if (!userService.loadingSignal() && userService.usersSignal().length > 0) {
      <div class="overflow-x-auto rounded-lg border border-slate-800">
        <table class="w-full text-sm" aria-label="Users table">
          <thead class="bg-slate-900 text-slate-400">
            <tr>
              <th scope="col" class="px-4 py-3 text-left">ID</th>
              <th scope="col" class="px-4 py-3 text-left">First</th>
              <th scope="col" class="px-4 py-3 text-left">Last</th>
              <th scope="col" class="px-4 py-3 text-left">Email</th>
              <th scope="col" class="px-4 py-3 text-left">Location</th>
              <th scope="col" class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800">
            @for (user of userService.usersSignal(); track user._id) {
              <tr class="hover:bg-slate-900/50 transition">
                <td class="px-4 py-3 text-slate-400 font-mono text-xs" [title]="user._id">
                  {{ user._id }}
                </td>
                <td class="px-4 py-3">{{ user.name.split(' ')[0] }}</td>
                <td class="px-4 py-3">{{ user.name.split(' ').slice(-1)[0] }}</td>
                <td class="px-4 py-3 text-slate-400">{{ user.email }}</td>
                <td class="px-4 py-3 text-slate-400">{{ user.location }}</td>
                <td class="px-4 py-3 flex gap-2">
                  <button
                    class="px-3 py-1 rounded bg-amber-500/90 hover:bg-amber-500 text-xs font-medium text-black focus:outline-none focus:ring-2 focus:ring-amber-400"
                    [aria-label]="'Edit user ' + user.name"
                    (click)="loadUserForEdit(user)"
                  >
                    Edit
                  </button>
                  <button
                    class="px-3 py-1 rounded bg-red-600/90 hover:bg-red-600 text-xs font-medium focus:outline-none focus:ring-2 focus:ring-red-400"
                    [aria-label]="'Delete user ' + user.name"
                    (click)="onDelete(user._id)"
                  >
                    Delete
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</main>
